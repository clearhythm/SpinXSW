<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Spin</title>
    <style>
    body {
      font-family: sans-serif;
    }
    </style>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script>
      var host = location.origin.replace(/^http/, 'ws')
      var ws = new WebSocket(host);
//       ws.onmessage = function (event) {
//         var li = document.createElement('li');
//         li.innerHTML = JSON.parse(event.data);
//         document.querySelector('#pings').appendChild(li);
//       };

//       var intId = window.setInterval(function(){
//         ws.send('FYI: ' + Date.now());
//       }, 1000);

//
//
//

    var recordedData = [];

    var recordDeviceMovement = function(){
      if ((window.DeviceMotionEvent) || ('listenForDeviceMovement' in window)) {
        recordedData = [];
        window.addEventListener('devicemotion', deviceMotionHandler, false);
        $('#record').prop('disabled', true);
        $('#send').prop('disabled', false);
        $('#stop').prop('disabled', false);
      } else {
        $('body').prepend('<h2>Not supported on your device or browser.  Sorry.</h2>');
      }
    };

    var sendRecordedDeviceMovement = function(){
      if (recordedData.length) {
        ws.send(recordedData.join(';'));
      } else {
        alert('Nothing to send!');
      }
    };

    var stopRecordingDeviceMovement = function(){
      window.removeEventListener('devicemotion', deviceMotionHandler, false);
      $('#record').prop('disabled', false);
      $('#send').prop('disabled', true);
      $('#stop').prop('disabled', true);
    };

    var deviceMotionHandler = function(eventData) {
      var info = '';

      if (eventData.acceleration) {
        var acceleration = eventData.acceleration;
        info += round(acceleration.x);
        info += ':' + round(acceleration.y);
        info = ':' + round(acceleration.z);
      } else {
        var acceleration = eventData.accelerationIncludingGravity;
        info += round(acceleration.x);
        info += ':' + round(acceleration.y);
        info = ':' + round(acceleration.z);
      }

      var rotation = eventData.rotationRate;
      info += ':' + round(rotation.alpha);
      info += ':' + round(rotation.beta);
      info += ':' + round(rotation.gamma);

      recordedData.push(info);
    };

    var round = function(val) {
      var amt = 10;
      return Math.round(val * amt) /  amt;
    };

    var init = function(){
      $('#record').on('click', function(){
        recordDeviceMovement();
      });

      $('#send').on('click', function(){
        sendRecordedDeviceMovement();
        stopRecordingDeviceMovement();
      });

      $('#stop').on('click', function(){
        stopRecordingDeviceMovement();
      });
    };
    </script>
  </head>
  <body>
    <h1>Spin</h1>
    <ul id='sequences'></ul>
    <button id='record'>Record</button>
    <button id='send' disabled>Send</button>
    <button id='stop' disabled>Stop</button>

    <script>init();</script>
  </body>
</html>
