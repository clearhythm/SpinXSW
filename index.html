<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Spin</title>
    <style>
    body {
      font-family: sans-serif;
    }
    </style>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/0.2.0/Chart.min.js"></script>
  </head>
  <body>
    <h1>Spin</h1>

    <button id="record">Record</button>
    <button id="send" disabled>Send</button>
    <button id="stop" disabled>Stop</button>

    <ul id="sequences"></ul>

    <canvas id="myChart" width="800" height="600"></canvas>

    <script>
    var host = location.origin.replace(/^http/, 'ws')
    var ws = new WebSocket(host);

    var dataSets = [];

    ws.onmessage = function (event) {
      console.log('onmessage', event);
      var id = dataSets.length;
      dataSets.push(event.data);
      $('#sequences').append('<li><button class="showDataSet" data-data-set-id="' + id + '">Dataset ' + id + '</button></li>');
    };

    $('#sequences').on('click', '.showDataSet', function(){
      var dataSetId = $(this).data('dataSetId');

      var dataSet = dataSets[dataSetId];
      var formattedData = [[], [], [], [], [], []];
      var labels = [];
      dataSet = dataSet.split(';');
      var i, l, j, m;
      for (i = 0, l = dataSet.length; i < l; i++) {
        dataSet[i] = dataSet[i].split(':');
        for (j = 0, m = dataSet[i].length; j < m; j++) {
          formattedData[j].push(dataSet[i][j]);
        };
        labels.push('');
      };

      var data = {
        labels : labels,
        datasets : [
          {
            fillColor : "rgba(220,220,220,0.5)",
            strokeColor : "rgba(220,220,220,1)",
            pointColor : "rgba(220,220,220,1)",
            pointStrokeColor : "#fff",
            data : formattedData[0]
          },
          {
            fillColor : "rgba(151,187,205,0.5)",
            strokeColor : "rgba(151,187,205,1)",
            pointColor : "rgba(151,187,205,1)",
            pointStrokeColor : "#fff",
            data : formattedData[1]
          },
          {
            fillColor : "rgba(220,220,220,0.5)",
            strokeColor : "rgba(220,220,220,1)",
            pointColor : "rgba(220,220,220,1)",
            pointStrokeColor : "#fff",
            data : formattedData[2]
          },
          {
            fillColor : "rgba(151,187,205,0.5)",
            strokeColor : "rgba(151,187,205,1)",
            pointColor : "rgba(151,187,205,1)",
            pointStrokeColor : "#fff",
            data : formattedData[3]
          },
          {
            fillColor : "rgba(220,220,220,0.5)",
            strokeColor : "rgba(220,220,220,1)",
            pointColor : "rgba(220,220,220,1)",
            pointStrokeColor : "#fff",
            data : formattedData[4]
          },
          {
            fillColor : "rgba(151,187,205,0.5)",
            strokeColor : "rgba(151,187,205,1)",
            pointColor : "rgba(151,187,205,1)",
            pointStrokeColor : "#fff",
            data : formattedData[5]
          }
        ]
      };

      var ctx = $("#myChart").get(0).getContext("2d");
      var myNewChart = new Chart(ctx).Line(data, {
        animation: false
      });
    });

    var recordedData = [];

    var recordDeviceMovement = function(){
      if ((window.DeviceMotionEvent) || ('listenForDeviceMovement' in window)) {
        recordedData = [];
        window.addEventListener('devicemotion', deviceMotionHandler, false);
        $('#record').prop('disabled', true);
        $('#send').prop('disabled', false);
        $('#stop').prop('disabled', false);
      } else {
        $('body').prepend('<h2>Not supported on your device or browser.  Sorry.</h2>');
      }
    };

    var sendRecordedDeviceMovement = function(){
      if (recordedData.length) {
        ws.send(recordedData.join(';'));
      } else {
        alert('Nothing to send!');
      }
    };

    var stopRecordingDeviceMovement = function(){
      window.removeEventListener('devicemotion', deviceMotionHandler, false);
      $('#record').prop('disabled', false);
      $('#send').prop('disabled', true);
      $('#stop').prop('disabled', true);
    };

    var deviceMotionHandler = function(eventData) {
      var info = '';

      if (eventData.acceleration) {
        var acceleration = eventData.acceleration;
        info += round(acceleration.x);
        info += ':' + round(acceleration.y);
        info += ':' + round(acceleration.z);
      } else {
        var acceleration = eventData.accelerationIncludingGravity;
        info += round(acceleration.x);
        info += ':' + round(acceleration.y);
        info += ':' + round(acceleration.z);
      }

      var rotation = eventData.rotationRate;
      info += ':' + round(rotation.alpha);
      info += ':' + round(rotation.beta);
      info += ':' + round(rotation.gamma);

      recordedData.push(info);
    };

    var round = function(val) {
      var amt = 10;
      return Math.round(val * amt) /  amt;
    };

    var init = function(){
      $('#record').on('click', function(){
        recordDeviceMovement();
      });

      $('#send').on('click', function(){
        sendRecordedDeviceMovement();
        stopRecordingDeviceMovement();
      });

      $('#stop').on('click', function(){
        stopRecordingDeviceMovement();
      });
    };

    init();
    </script>
  </body>
</html>
